<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ ¡å­¦ä¹ èµ„æ–™å…±äº«å¹³å°</title>
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #66b1ff;
        }
        .btn-success {
            background: #67c23a;
        }
        .btn-success:hover {
            background: #85ce61;
        }
        .input {
            width: 100%;
            padding: 10px;
            border: 1px solid #dcdfe6;
            border-radius: 5px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .resource-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            background: #f0f9ff;
            color: #1e40af;
            border-radius: 3px;
            font-size: 12px;
            margin: 2px;
        }
        .hidden {
            display: none;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .search-bar input, .search-bar select {
            flex: 1;
            min-width: 150px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #409eff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ å®¶æ ¡å­¦ä¹ èµ„æ–™å…±äº«å¹³å°</h1>
        <p>åŸºäºç§¯åˆ†æœºåˆ¶çš„å­¦ä¹ èµ„æºå…±äº«ç¤¾åŒº</p>
        <div id="auth-buttons">
            <button class="btn" onclick="showLogin()">ç™»å½•</button>
            <button class="btn btn-success" onclick="showRegister()">æ³¨å†Œ</button>
        </div>
        <div id="user-menu" class="hidden">
            <span id="user-name">ç”¨æˆ·</span>
            <button class="btn" onclick="logout()">é€€å‡º</button>
        </div>
    </div>

    <div class="container">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div id="user-info" class="user-info hidden">
            <h3>æ¬¢è¿å›æ¥ï¼Œ<span id="user-nickname">ç”¨æˆ·</span>ï¼</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="user-points">0</div>
                    <div class="stat-label">ç§¯åˆ†</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="user-level">æ–°æ‰‹ç”¨æˆ·</div>
                    <div class="stat-label">ç­‰çº§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="user-downloads">0</div>
                    <div class="stat-label">ä»Šæ—¥ä¸‹è½½</div>
                </div>
            </div>
            <div>
                <button class="btn" onclick="dailySignIn()">æ¯æ—¥ç­¾åˆ°</button>
                <button class="btn btn-success" onclick="showUpload()">ä¸Šä¼ èµ„æº</button>
            </div>
        </div>

        <!-- æœç´¢ç­›é€‰ -->
        <div class="card">
            <h3>ğŸ” æœç´¢ç­›é€‰</h3>
            <div class="search-bar">
                <input type="text" id="search-keyword" placeholder="æœç´¢èµ„æº..." class="input">
                <select id="search-grade" class="input">
                    <option value="">é€‰æ‹©å¹´çº§</option>
                    <option value="å°å­¦1å¹´çº§">å°å­¦1å¹´çº§</option>
                    <option value="å°å­¦2å¹´çº§">å°å­¦2å¹´çº§</option>
                    <option value="å°å­¦3å¹´çº§">å°å­¦3å¹´çº§</option>
                    <option value="å°å­¦4å¹´çº§">å°å­¦4å¹´çº§</option>
                    <option value="å°å­¦5å¹´çº§">å°å­¦5å¹´çº§</option>
                    <option value="é¢„åˆ">é¢„åˆ</option>
                    <option value="åˆä¸­1å¹´çº§">åˆä¸­1å¹´çº§</option>
                    <option value="åˆä¸­2å¹´çº§">åˆä¸­2å¹´çº§</option>
                    <option value="åˆä¸­3å¹´çº§">åˆä¸­3å¹´çº§</option>
                    <option value="é«˜ä¸­1å¹´çº§">é«˜ä¸­1å¹´çº§</option>
                    <option value="é«˜ä¸­2å¹´çº§">é«˜ä¸­2å¹´çº§</option>
                    <option value="é«˜ä¸­3å¹´çº§">é«˜ä¸­3å¹´çº§</option>
                </select>
                <select id="search-subject" class="input">
                    <option value="">é€‰æ‹©ç§‘ç›®</option>
                    <option value="è¯­æ–‡">è¯­æ–‡</option>
                    <option value="æ•°å­¦">æ•°å­¦</option>
                    <option value="è‹±è¯­">è‹±è¯­</option>
                    <option value="ç‰©ç†">ç‰©ç†</option>
                    <option value="åŒ–å­¦">åŒ–å­¦</option>
                    <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                    <option value="å†å²">å†å²</option>
                    <option value="åœ°ç†">åœ°ç†</option>
                    <option value="æ”¿æ²»">æ”¿æ²»</option>
                </select>
                <select id="search-type" class="input">
                    <option value="">èµ„æºç±»å‹</option>
                    <option value="è¯¾ä»¶">è¯¾ä»¶</option>
                    <option value="æ•™æ¡ˆ">æ•™æ¡ˆ</option>
                    <option value="å­¦æ¡ˆ">å­¦æ¡ˆ</option>
                    <option value="ä½œä¸š">ä½œä¸š</option>
                    <option value="è¯•å·">è¯•å·</option>
                    <option value="é¢˜é›†">é¢˜é›†</option>
                    <option value="ç´ æ">ç´ æ</option>
                    <option value="å¤‡è¯¾åŒ…">å¤‡è¯¾åŒ…</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <button class="btn" onclick="searchResources()">æœç´¢</button>
            </div>
        </div>

        <!-- èµ„æºåˆ—è¡¨ -->
        <div class="card">
            <h3>ğŸ“š å­¦ä¹ èµ„æº</h3>
            <div id="resources-container">
                <div class="resource-grid" id="resources-grid">
                    <!-- èµ„æºå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content">
            <h3>ç”¨æˆ·ç™»å½•</h3>
            <div class="form-group">
                <label>æ‰‹æœºå·</label>
                <input type="text" id="login-phone" class="input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="login-password" class="input" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <div>
                <button class="btn" onclick="hideLogin()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="login()">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="register-modal" class="modal hidden">
        <div class="modal-content">
            <h3>ç”¨æˆ·æ³¨å†Œ</h3>
            <div class="form-group">
                <label>æ‰‹æœºå·</label>
                <input type="text" id="register-phone" class="input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="form-group">
                <label>æ˜µç§°</label>
                <input type="text" id="register-nickname" class="input" placeholder="è¯·è¾“å…¥æ˜µç§°">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="register-password" class="input" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <div class="form-group">
                <label>ç¡®è®¤å¯†ç </label>
                <input type="password" id="register-confirm" class="input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>
            <div class="form-group">
                <label>åŸå¸‚</label>
                <input type="text" id="register-city" class="input" placeholder="è¯·è¾“å…¥æ‰€åœ¨åŸå¸‚">
            </div>
            <div class="form-group">
                <label>å­©å­å¹´çº§</label>
                <select id="register-grade" class="input">
                    <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                    <option value="å°å­¦1å¹´çº§">å°å­¦1å¹´çº§</option>
                    <option value="å°å­¦2å¹´çº§">å°å­¦2å¹´çº§</option>
                    <option value="å°å­¦3å¹´çº§">å°å­¦3å¹´çº§</option>
                    <option value="å°å­¦4å¹´çº§">å°å­¦4å¹´çº§</option>
                    <option value="å°å­¦5å¹´çº§">å°å­¦5å¹´çº§</option>
                    <option value="é¢„åˆ">é¢„åˆ</option>
                    <option value="åˆä¸­1å¹´çº§">åˆä¸­1å¹´çº§</option>
                    <option value="åˆä¸­2å¹´çº§">åˆä¸­2å¹´çº§</option>
                    <option value="åˆä¸­3å¹´çº§">åˆä¸­3å¹´çº§</option>
                    <option value="é«˜ä¸­1å¹´çº§">é«˜ä¸­1å¹´çº§</option>
                    <option value="é«˜ä¸­2å¹´çº§">é«˜ä¸­2å¹´çº§</option>
                    <option value="é«˜ä¸­3å¹´çº§">é«˜ä¸­3å¹´çº§</option>
                </select>
            </div>
            <div>
                <button class="btn" onclick="hideRegister()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let resources = [];
        let isLoggedIn = false;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadResources();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showAuthButtons();
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/me/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    isLoggedIn = true;
                    showUserInfo();
                } else {
                    localStorage.removeItem('access_token');
                    showAuthButtons();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                showAuthButtons();
            }
        }

        // æ˜¾ç¤ºè®¤è¯æŒ‰é’®
        function showAuthButtons() {
            document.getElementById('auth-buttons').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo() {
            document.getElementById('auth-buttons').classList.add('hidden');
            document.getElementById('user-menu').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');

            document.getElementById('user-name').textContent = currentUser.nickname || 'ç”¨æˆ·';
            document.getElementById('user-nickname').textContent = currentUser.nickname || 'ç”¨æˆ·';
            document.getElementById('user-points').textContent = currentUser.points || 0;
            document.getElementById('user-level').textContent = currentUser.level || 'æ–°æ‰‹ç”¨æˆ·';
            document.getElementById('user-downloads').textContent = currentUser.daily_downloads || 0;
        }

        // åŠ è½½èµ„æºåˆ—è¡¨
        async function loadResources() {
            try {
                const response = await fetch('/api/v1/resources/');
                const data = await response.json();
                resources = data.items || [];
                renderResources(resources);
            } catch (error) {
                console.error('åŠ è½½èµ„æºå¤±è´¥:', error);
                document.getElementById('resources-grid').innerHTML = '<p>åŠ è½½èµ„æºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
        }

        // æ¸²æŸ“èµ„æºåˆ—è¡¨
        function renderResources(resourceList) {
            const container = document.getElementById('resources-grid');
            if (!resourceList || resourceList.length === 0) {
                container.innerHTML = '<p>æš‚æ— èµ„æº</p>';
                return;
            }

            container.innerHTML = resourceList.map(resource => `
                <div class="resource-card">
                    <h4>${resource.title}</h4>
                    <p>${resource.description || 'æš‚æ— æè¿°'}</p>
                    <div>
                        <span class="tag">${resource.grade}</span>
                        <span class="tag">${resource.subject}</span>
                        <span class="tag">${resource.resource_type}</span>
                    </div>
                    <div style="margin: 10px 0; color: #666; font-size: 12px;">
                        <span>ä¸‹è½½: ${resource.download_count}æ¬¡</span> |
                        <span>å¤§å°: ${formatFileSize(resource.file_size)}</span> |
                        <span>ç±»å‹: ${resource.file_type}</span>
                    </div>
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn" onclick="viewResource(${resource.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-success" onclick="downloadResource(${resource.id})" ${!isLoggedIn ? 'disabled' : ''}>
                            ä¸‹è½½ (10ç§¯åˆ†)
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æœç´¢èµ„æº
        async function searchResources() {
            const keyword = document.getElementById('search-keyword').value;
            const grade = document.getElementById('search-grade').value;
            const subject = document.getElementById('search-subject').value;
            const resourceType = document.getElementById('search-type').value;

            const params = new URLSearchParams();
            if (keyword) params.append('q', keyword);
            if (grade) params.append('grade', grade);
            if (subject) params.append('subject', subject);
            if (resourceType) params.append('resource_type', resourceType);

            try {
                const response = await fetch(`/api/v1/search/?${params}`);
                const data = await response.json();
                renderResources(data.items || []);
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                alert('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLogin() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        // éšè—ç™»å½•æ¨¡æ€æ¡†
        function hideLogin() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegister() {
            document.getElementById('register-modal').classList.remove('hidden');
        }

        // éšè—æ³¨å†Œæ¨¡æ€æ¡†
        function hideRegister() {
            document.getElementById('register-modal').classList.add('hidden');
        }

        // ç™»å½•
        async function login() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-password').value;

            if (!phone || !password) {
                alert('è¯·å¡«å†™æ‰‹æœºå·å’Œå¯†ç ');
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    alert('ç™»å½•æˆåŠŸï¼');
                    hideLogin();
                    checkLoginStatus();
                } else {
                    alert(data.detail || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ³¨å†Œ
        async function register() {
            const phone = document.getElementById('register-phone').value;
            const nickname = document.getElementById('register-nickname').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            const city = document.getElementById('register-city').value;
            const childGrade = document.getElementById('register-grade').value;

            if (!phone || !nickname || !password || !confirmPassword || !childGrade) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone,
                        nickname,
                        password,
                        confirm_password: confirmPassword,
                        city,
                        child_grade: childGrade
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                    hideRegister();
                    showLogin();
                } else {
                    alert(data.detail || 'æ³¨å†Œå¤±è´¥');
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('access_token');
            currentUser = null;
            isLoggedIn = false;
            showAuthButtons();
            alert('å·²é€€å‡ºç™»å½•');
        }

        // æ¯æ—¥ç­¾åˆ°
        async function dailySignIn() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/signin/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('ç­¾åˆ°æˆåŠŸï¼è·å¾—5ç§¯åˆ†');
                    checkLoginStatus(); // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                } else {
                    alert(data.detail || 'ç­¾åˆ°å¤±è´¥');
                }
            } catch (error) {
                console.error('ç­¾åˆ°å¤±è´¥:', error);
                alert('ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æŸ¥çœ‹èµ„æºè¯¦æƒ…
        function viewResource(resourceId) {
            const resource = resources.find(r => r.id === resourceId);
            if (resource) {
                alert(`èµ„æºè¯¦æƒ…ï¼š
æ ‡é¢˜ï¼š${resource.title}
æè¿°ï¼š${resource.description || 'æš‚æ— æè¿°'}
å¹´çº§ï¼š${resource.grade}
ç§‘ç›®ï¼š${resource.subject}
ç±»å‹ï¼š${resource.resource_type}
æ–‡ä»¶å¤§å°ï¼š${formatFileSize(resource.file_size)}
ä¸‹è½½æ¬¡æ•°ï¼š${resource.download_count}`);
            }
        }

        // ä¸‹è½½èµ„æº
        async function downloadResource(resourceId) {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            try {
                const response = await fetch(`/api/v1/resources/${resourceId}/download/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('ä¸‹è½½æˆåŠŸï¼');
                    checkLoginStatus(); // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                } else {
                    alert(data.detail || 'ä¸‹è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºä¸Šä¼ æ¨¡æ€æ¡†
        function showUpload() {
            alert('ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
